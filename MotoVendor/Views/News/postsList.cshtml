@inject BusinessLogic.Services.Interfaces.IUserService UserService
@model List<BusinessLogic.DTO.Post.GetPostDTO>
@{
    ViewData["Title"] = "News - Posts List";
    var user = UserService.GetCurrentUser().Result;
}
@section Styles {
    <link rel="stylesheet" href="~/css/postsList.css" />
}
@section Scripts {
    <script src="~/js/postComments.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const comments = document.querySelectorAll('.comments-content');
            comments.forEach(comment => {
                const commentContentSection = comment.querySelector('.editable-post-content');
                const immutableContentSection = commentContentSection.querySelector('.editable-content');
                const mutableContentSection = commentContentSection.querySelector('.editable-content-section');
                function switchContentSection(section) {
                    if (section === "immutable") {
                        mutableContentSection.style.display = 'none';
                        immutableContentSection.style.display = 'block';
                    }
                    else if (section === "mutable") {
                        mutableContentSection.style.display = 'block';
                        immutableContentSection.style.display = 'none';
                    }
                }
                const editButton = comment.querySelector('#edit-comment-btn');
                editButton.addEventListener('click', () => {
                    switchContentSection("mutable");
                    switchContentSectionButtonVisiblity("immutable");
                });
                const cancelButton = comment.querySelector('#cancel-edit-btn');
                cancelButton.addEventListener('click', () => {
                    switchContentSection("immutable");
                    switchContentSectionButtonVisiblity("mutable");
                });
                function switchContentSectionButtonVisiblity(sectionButton) {
                    if (sectionButton === "immutable") {
                        cancelButton.style.display = 'block';
                        editButton.style.display = 'none';
                    }
                    else if (sectionButton === "mutable") {
                        editButton.style.display = 'block';
                        cancelButton.style.display = 'none';
                    }
                }
            });
        });
    </script>
}

<div class="postList">
    <div class="listNews">
        <section>
            <div class="up-section">
                <div class="nav-tree">
                    <label for="place">News</label>
                </div>
                <div class="sort">
                    <label for="sort_by">Sort By</label>
                    <select id="type">
                        <option value="date_adc">Date ACS</option>
                        <option value="date_desc">Date DESC</option>
                        <option value="alpabetical_asc">Alpabetical ACS</option>
                        <option value="alphabetical_desc">Alpabetical DESC</option>
                    </select>
                </div>
            </div>
            <div class="second-section">
                <div class="filter-by">
                    <label>Filter by</label>
                    <button class="clear">
                        <span>X Clear All</span>
                    </button>
                </div>
                <form asp-action="PostsList" method="get">
                    <div class="filter-group">
                        <div class="date-group">
                            <label for="datetime-from">Date from</label>
                            <input type="datetime-local" id="datetime-from" name="creationTimeGTE">
                        </div>
                        <div class="date-group">
                            <label for="datetime-to">Date to</label>
                            <input type="datetime-local" id="datetime-to" name="creationTimeLTE">
                        </div>
                    </div>
                    <div class="location-group">
                        <label for="status">Status</label>
                        <div class="status-group">
                            <label class="status">Owner</label>
                            <input type="checkbox" id="status1" name="relationStatus" value="owner">
                        </div>
                        <div class="status-group">
                            <label class="status">Liked</label>
                            <input type="checkbox" id="status2" name="relationStatus" value="interested">
                        </div>
                        <div class="status-group">
                            <label class="status">Member</label>
                            <input type="checkbox" id="status3" name="relationStatus" value="member">
                        </div>
                    </div>
                    <div class="search-bar">
                        <img src="~/images/peel.svg" alt="peel" class="peel-icon" id="peel-icon">
                        <input type="text" id="search" name="search" placeholder="Search">
                    </div>
                    <button type="submit">Apply Filters</button>
                </form>
                <div class="adding-section">
                    <a class="add-section" asp-action="AddPost">
                        Plan new event
                    </a>
                </div>
            </div>
        </section>
        <main>
            <ul>
                @foreach (var post in @Model)
                {
                    <li class="posts--post">
                        @if(user != null && post.Publisher != null && post.Publisher.Id == user.Id)
                        {
                            <a class="edit-btn" asp-action="EditPost" asp-route-id="@post.Id">
                                <img src="~/images/draw.png" alt="edit" class="edit-icon" id="edit-icon">
                            </a>
                        }
                        <div class="main-post">
                            <div class="post-info">
                                <div class="profile">
                                    <button class="profile-btn">
                                        <img src="~/images/profilowe.jpg" alt="delete" class="x-icon" id="x-image">
                                    </button>
                                    <span>@post.Publisher?.UserName</span>
                                </div>
                                <div class="create-time">
                                    <img src="~/images/clock.png" alt="clock" class="clock-icon" id="clock-icon">
                                    <div class="date">
                                        <span>@post.PublicationTime</span>
                                    </div>
                                </div>
                            </div>
                            <img src="data:image/@post.Image?.Extension;base64,@post.Image?.Base64" alt="photo" class="photo" id="photo">
                            <div class="post-content">
                                <span>
                                    <pre>@post.Content</pre>
                                </span>
                            </div>
                            <div class="line">
                            </div>
                            <div class="action-group">
                                <div class="interacted-group">
                                    <button class="like-btn">
                                        <img src="~/images/like.png" alt="like" class="like-icon" id="like-image">
                                    </button>
                                    <span>3304</span>
                                </div>
                                <div class="interacted-group">
                                    <button class="comments-btn">
                                        <img src="~/images/comments.png" alt="comments" class="comments-icon" id="comments-image">
                                    </button>
                                    <span><b>Comments</b></span>
                                </div>
                            </div>
                        </div>
                        <button class="x-btn">
                            <img src="~/images/x-button.png" alt="delete" class="x-icon" id="x-image">
                        </button>
                        <div class="commentsWindow-container">
                            <div id="commentsWindow" class="commentsWindow">
                                @foreach(var comment in post.PostComments)
                                {
                                    <div class="comments-content"> 
                                        @if(user != null && post.Publisher != null && comment.Publisher?.Id == user.Id)
                                        {
                                            <button style="display: block" id="edit-comment-btn" class="edit-comment-btn">
                                                <img src="~/images/draw.png" alt="edit" class="edit-icon" id="edit-icon">
                                            </button>
                                            <button style="display: none" id="cancel-edit-btn" class="cancel-edit-btn">
                                                <img src="~/images/x-button.png" alt="cancel" class="cancel-icon" id="cancel-icon">
                                            </button>
                                        }
                                        <div class="main-post">
                                            <div class="post-info">
                                                <div class="profile">
                                                    <button class="profile-btn">
                                                        <img src="~/images/profilowe.jpg" alt="profil-img" class="profil-img" id="profil-img">
                                                    </button>
                                                    <span>@comment.Publisher?.UserName</span>
                                                </div>
                                                <div class="create-time">
                                                    <img src="~/images/clock.png" alt="clock" class="clock-icon" id="clock-icon">
                                                    <div class="date">
                                                        @comment.CreationTime
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="editable-post-content">
                                                <span id="editable-content" class="editable-content">
                                                    @comment.Content
                                                </span>
                                                <form style="display: none" class="editable-content-section" asp-action="UpdatePostComment" asp-route-id="@comment.Id">
                                                    <textarea name="Content">@comment.Content</textarea>
                                                    <button type="submit">Update comment</button>
                                                </form>
                                            </div>
                                            <div class="line">
                                            </div>
                                            <div class="action-group">
                                                <div class="interacted-group">
                                                    <a class="like-btn" asp-action="PostCommentLike" asp-route-postCommentId="@comment.Id">
                                                        <img src="~/images/like.png" alt="like" class="like-icon" id="like-image">
                                                    </a>
                                                    @{
                                                        var likeCount = 0;
                                                        if (comment?.Reactions != null)
                                                        {
                                                            likeCount = comment.Reactions
                                                            .Where(reaction => reaction.ReactionType == DB.Enums.ReactionType.Like)
                                                            .Count();
                                                        }
                                                    }
                                                    <span>@likeCount</span>
                                                    <a class="dislike-btn" asp-action="PostCommentDislike" asp-route-postCommentId="@comment.Id">
                                                        <img src="~/images/dislike.png" alt="dislike" class="dislike-icon" id="dislike-image">
                                                    </a>
                                                    @{
                                                        var dislikeCount = 0;
                                                        if (comment?.Reactions != null)
                                                        {
                                                            dislikeCount = comment.Reactions
                                                            .Where(reaction => reaction.ReactionType == DB.Enums.ReactionType.Dislike)
                                                            .Count();
                                                        }
                                                    }
                                                    <span>@dislikeCount</span>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="x-btn">
                                            <img src="~/images//trash-bin.png" alt="delete" class="x-icon" id="x-image">
                                        </button>
                                    </div>
                                }
                                <form class="add-comment-content" asp-action="AddPostComment" asp-route-id="@post.Id" method="post">
                                    <button id="edit-comment-btn" class="edit-comment-btn">
                                        <img src="~/images/draw.png" alt="edit" class="edit-icon" id="edit-icon">
                                    </button>
                                    <div class="main-post">
                                        <div class="main-post__inner">
                                            <div class="post-content">
                                                <textarea name="Content" id="comment-textarea" placeholder="Write to comment"></textarea>
                                            </div>
                                            <div class="line-add">
                                            </div>
                                            <button class="add-comment__submit-btn" type="submit">Add comment</button>
                                            <div id="new-comment-action" class="comment-action">
                                                <button id="cancel-btn" class="cancel-btn">
                                                    <span>Cancel</span>
                                                </button>
                                                <button class="comment-btn">
                                                    <span>Comment</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </li>
                }
                </ul>
        </main>
    </div>
    <div id="comment-modal">
    </div>
</div>

